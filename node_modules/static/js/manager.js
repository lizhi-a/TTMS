
// 功能：处理全局需用到的js,除去表单提交

$('.menu_li').each(function (index) {
  $(this).on('click', function () {
    $('.menu_li').each(function () {
      $(this).css("background-color", "rgb(247, 247, 247)");
    })
    $(this).css({ "background-color": "rgb(243, 242, 242)" });

    $('.right_box').each(function () {
      $(this).css("display", "none");
    })

    // var element = $('.right_box')[index];
    // $(element).css("display", "block");
  })
})


// 功能：点击左侧电影院菜单，右侧显示对应部分

$('#menu_cinema').on('click', function () {
  var total_staff_pages = ''
  $.ajax({
    url: `http://localhost:8080/getCinemas/1`,
    type: 'get',
    dataType: 'json',
    async: false,
    success: data => {
      // console.log('获取电影院信息', data)
      var str = `
          <div class="title_list content_line">
            <p class="content_li cinema_name">影院名称</p>
            <p class="content_li cinema_address">地址</p>
            <p class="content_li cinema_img  cinema_title_img">照片</p>
            <p class="content_li cinema_money">盈利</p>
            <p class="content_li cinema_num">电话</p>
            <p class="content_li cinema_email">邮箱</p>
            <p class="content_title cinema_operate">操作</p>
          </div>`
      // <span class="modify_img">修改</span>
      for (var i = 0; i < data.length - 1; i++) {
        str += `
          <form class="content_line">
            <input value="${data[i].id}" hidden>
            <p class="content_li cinema_name">${data[i].cinemaName}</p>
            <p class="content_li cinema_address">${data[i].cinemaAddress}</p>
            <p class="content_li cinema_img"><img src="${data[i].cinemaPicture}" alt="图片未加载成功"><input class="file_input" onchange="previewImage(this)" type="file"></p>
            <p class="content_li cinema_money">${data[i].cinemaMoney}</p>
            <p class="content_li cinema_num">${data[i].cinemaNumber}</p>
            <p class="content_li cinema_email">${data[i].cinemaEmail}</p>
            <p class="content_li cinema_operate">
              <button type="reset" onclick="edit_cinema(this)" class="edit_button">编辑</button>
              <button type="reset" class="delete_button delete_cinema">删除</button>
            </p>
          </form>`
      }

      var parent = $('.right_content').eq(0)
      parent.empty()
      parent.append(`${str}`)
      total_staff_pages = (Number(data[data.length - 1].cinemaName)) * 5

    }
  })

  layui.use('laypage', function () {
    var laypage = layui.laypage;

    // 执行一个laypage实例
    laypage.render({
      elem: 'cinema_paging' //注意，这里的 test1 是 ID，不用加 # 号
      , count: total_staff_pages //数据总数，从服务端得到
      , limit: 5
      , theme: '#4299e1'
      // 当分页被切换时触发，函数返回两个参数：
      // obj（当前分页的所有选项值）、first（是否首次，一般用于初始加载的判断）
      , jump: function (obj, first) {
        //obj包含了当前分页的所有参数，比如：
        // console.log(obj.curr); //得到当前页，以便向服务端请求对应页的数据。

        $.ajax({
          url: `http://localhost:8080/getCinemas/${obj.curr}`,
          type: 'get',
          dataType: 'json',
          async: false,
          success: data => {
            console.log('分页电影院', data)

            var parent = $('.right_content').eq(0)
            parent.empty()

            var str = `
                <div class="title_list content_line">
                  <p class="content_li cinema_name">影院名称</p>
                  <p class="content_li cinema_address">地址</p>
                  <p class="content_li cinema_img  cinema_title_img">照片</p>
                  <p class="content_li cinema_money">盈利</p>
                  <p class="content_li cinema_num">电话</p>
                  <p class="content_li cinema_email">邮箱</p>
                  <p class="content_title cinema_operate">操作</p>
                </div>`
            for (var i = 0; i < data.length - 1; i++) {
              str += `
                  <form class="content_line">
                    <input value="${data[i].id}" hidden>
                    <p class="content_li cinema_name">${data[i].cinemaName}</p>
                    <p class="content_li cinema_address">${data[i].cinemaAddress}</p>
                    <p class="content_li cinema_img"><img src="${data[i].cinemaPicture}" alt="图片未加载成功"><input class="file_input" onchange="previewImage(this)" type="file"></p>
                    <p class="content_li cinema_money">${data[i].cinemaMoney}</p>
                    <p class="content_li cinema_num">${data[i].cinemaNumber}</p>
                    <p class="content_li cinema_email">${data[i].cinemaEmail}</p>
                    <p class="content_li cinema_operate">
                      <button type="reset" onclick="edit_cinema(this)" class="edit_button">编辑</button>
                      <button type="reset" class="delete_button delete_cinema">删除</button>
                    </p>
                  </form>`
            }
            parent.append(`${str}`)
          }
        })
      }
    })
  })
  // 对应盒子显示

  $('.right_box').each(function () {
    $(this).css("display", "none");
  })

  var element = $('.right_box')[0];
  $(element).css("display", "block");
})


// 功能:点击左侧电影管理,右侧显示对应部分
$('#menu_movie').on('click', function () {
  function GetTime(date) {
    var datee = new Date(date).toJSON();
    return new Date(+new Date(datee) + 8 * 3600 * 1000).toISOString().
      replace(/T/g, ' ').replace(/\.[\d]{3}Z/, '')
  }

  $.ajax({
    url: `http://localhost:8080/AdminGetMovies`,
    type: 'get',
    dataType: 'json',
    async: false,
    contentType: 'application/json;charset=UTF-8',
    success: data => {

      console.log('点击li的电影信息', data)
      var str = ``
      for (var i = 0; i < data.length; i++) {
        // 导演信息拼接为字符串
        let actorList = ''
        if (data[i].movieActorList != null) {
          for (let j = 0; j < data[i].movieActorList.length; j++) {
            actorList += data[i].movieActorList[j].actorName + ' 、'
          }
          actorList = actorList.substr(0, actorList.length - 2)
        }

        // console.log(actorList)
        // 将电影评分分开显示，整数位直接字符串截取，小数位需要判断是否为空
        let decimal_score = ''
        if (String(data[i].movieScore).substring(2, 3) == '') {
          decimal_score = '0';
        } else {
          decimal_score = String(data[i].movieScore).substring(2, 3)
        }
        // 
        // <button class="delete_movie">删除电影</button>

        str += `
          <div class="movie_box" id="${data[i].id}">
            <img class="film_img"
              src="${data[i].movieHead}" alt="电影图片" />
            <div class="film_intro">
              <input value="${data[i].id}" type="text" hidden>
              <input value="${data[i].movieName}" type="text" hidden>
              <input value="${String(data[i].movieScore)}" type="text" hidden>
              <input value="${data[i].movieMinute}" type="text" hidden>
              <input value="${data[i].movieType}" type="text" hidden>
              <input value="${GetTime(data[i].movieStart).substring(0, 10)}" type="text" hidden>
              <input value="${data[i].movieArea}" type="text" hidden>
              <input value="${data[i].wantLook}" type="text" hidden>
              <input value="${data[i].movieHead}" type="text" hidden>
              <input value="${data[i].movieStatus}" type="text" hidden>
              <input value="${data[i].movieBrief}" type="text" hidden>
              <p><span class="film_intro_name">${data[i].movieName}</span><span class="film_intro_score"><big>${String(data[i].movieScore).substring(0, 1)}</big>.${decimal_score} </span></p>
              <p><span class="film_title">类型：</span><span class="film_sort_detail">${data[i].movieType}</span></p>
              <p><span class="film_title">演员：</span><span class="film_actor_detail">${actorList}</span></p>
              <p><span class="film_title">上映时间：</span><span class="film_time_detail">${GetTime(data[i].movieStart).substring(0, 10)}</span></p>
            </div>
          </div>`
      }
      var parent = $('.right_content').eq(1)
      parent.empty()
      parent.append(`${str}`)

    }
  })

  $('.right_box').each(function () {
    $(this).css("display", "none");
  })

  var element = $('.right_box')[1]
  $(element).css("display", "block");

})


// 票房管理
$('#menu_office').on('click', function () {
  function GetTime(date) {
    var datee = new Date(date).toJSON();
    return new Date(+new Date(datee) + 8 * 3600 * 1000).toISOString().
      replace(/T/g, ' ').replace(/\.[\d]{3}Z/, '')
  }
  var total_movie_pages = ''

  $.ajax({
    url: `http://localhost:8080/getAllMoney/1`,
    type: 'get',
    dataType: 'json',
    async: false,
    contentType: 'application/json;charset=UTF-8',
    success: data => {
      console.log('点击li的票房信息', data)
      var movie = data

      // 电影票房渲染
      var str_movie = `
                <div class="content_line">
                  <p class="content_li cinema_title">电影名称</p>
                  <p class="content_li cinema_title">上映时间</p>
                  <p class="content_li cinema_title">状态</p>
                  <p class="content_li cinema_title">票房</p>
                </div>`
      for (var i = 0; i < movie.length - 1; i++) {
        let movieStatus
        switch (movie[i].movieStatus) {
          case 1: movieStatus = '正在热映'; break;
          case 2: movieStatus = '即将上演'; break;
          case 3: movieStatus = '热播电影'; break;
        }
        str_movie += `
            <form action="" class="content_line">
              <p class="content_li">${(movie[i]).movieName}</p>
              <p class="content_li">${GetTime((movie[i]).movieStart).substring(0, 11)}</p>
              <p class="content_li">${movieStatus}</p>
              <p class="content_li">${movie[i].movieMoney}元</p>
            </form>`
      }

      var parent = $('#office_content')
      parent.empty()
      parent.append(`${str_movie}`)


      total_movie_pages = (Number(movie[movie.length - 1].id)) * 10
      console.log(total_movie_pages)
    }
  })

  layui.use('laypage', function () {
    var laypage = layui.laypage;

    // 执行一个laypage实例
    laypage.render({
      elem: 'office_pages' //注意，这里的 test1 是 ID，不用加 # 号
      , count: total_movie_pages //数据总数，从服务端得到
      , limit: 10
      , theme: '#4299e1'
      // 当分页被切换时触发，函数返回两个参数：
      // obj（当前分页的所有选项值）、first（是否首次，一般用于初始加载的判断）
      , jump: function (obj, first) {
        //obj包含了当前分页的所有参数，比如：
        // console.log(obj.curr); //得到当前页，以便向服务端请求对应页的数据。


        $.ajax({
          url: `http://localhost:8080/getAllMoney/${obj.curr}`,
          type: 'get',
          dataType: 'json',
          async: false,
          contentType: 'application/json;charset=UTF-8',
          success: data => {
            console.log('上下页票房信息', data)
            var movie = data

            // 电影票房渲染
            var str_movie = `
                <div class="content_line">
                  <p class="content_li cinema_title">电影名称</p>
                  <p class="content_li cinema_title">上映时间</p>
                  <p class="content_li cinema_title">状态</p>
                  <p class="content_li cinema_title">票房</p>
                </div>`
            for (var i = 0; i < movie.length - 1; i++) {
              let movieStatus
              switch (movie[i].movieStatus) {
                case 1: movieStatus = '正在热映'; break;
                case 2: movieStatus = '即将上演'; break;
                case 3: movieStatus = '热播电影'; break;
              }
              str_movie += `
            <form action="" class="content_line">
              <p class="content_li">${(movie[i]).movieName}</p>
              <p class="content_li">${GetTime((movie[i]).movieStart).substring(0, 11)}</p>
              <p class="content_li">${movieStatus}</p>
              <p class="content_li">${movie[i].movieMoney}元</p>
            </form>`
            }

            var parent = $('#office_content')
            parent.empty()
            parent.append(`${str_movie}`)


            total_movie_pages = (Number(movie[movie.length - 1].id)) * 10
            console.log(total_movie_pages)
          }
        })
      }
    })
  })

  $('.right_box').each(function () {
    $(this).css("display", "none");
  })

  var element = $('.right_box')[2]
  $(element).css("display", "block");
})