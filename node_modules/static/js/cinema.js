
// 功能：点击新增影厅按钮，出现新增影厅的弹框

$('#new_cinema').on("click", function () {
  $('#float_cinema').css({ "display": "block" })
  $('#new_cinema_form').css({ "display": "block" })
  $('#edit_cinema_form').css({ "display": "none" })
})


// 功能：取消新增影厅弹框

$('#cancel_new_cinema').on("click", function () {
  $('#float_cinema').css({ "display": "none" })
  $('#new_cinema_form').css({ "display": "none" })
  $('#edit_cinema_form').css({ "display": "none" })
})


// 功能：提交新增影厅表单
$('#new_cinema_form').on('submit', e => {
  e.preventDefault()
  const formData = $('#new_cinema_form').serializeArray()
  var o = {}
  $.each(formData, function () {
    if (o[this.name]) {
      if (!o[this.name].push) {
        o[this.name] = [o[this.name]];
      }
      o[this.name].push(this.value || '');
    } else {
      o[this.name] = this.value || '';
    }
  })

  var parent = $('.right_content').eq(0)

  var province = $('.province-selector').children()
  var city = $('.city-selector').children()
  var county = $('.county-selector').children()

  Object.keys(county).forEach(function (key) {
    if (o.county == county[key].innerHTML) {
      o.countyId = county[key].getAttribute("name")
      // console.log(county[key].getAttribute("name"), county[key])
    }
  })

  let obj = {
    "areaId": Number(`${o.countyId}`),
    "cinemaAddress": `${o.province}${o.city}${o.county}${o.detail_address}`,
    "cinemaName": `${o.name}`,
    "cinemaNumber": `${o.number}`,
    "cinemaEmail": `${o.email}`
    // "cinemaMoney": 0,
  }

  console.log(obj)
  obj = JSON.stringify(obj)
  console.log(obj)

  $.ajax({
    url: 'http://localhost:8080/addCinemas',
    type: 'POST',
    data: obj,
    dataType: 'json',
    catch: false,      //清除上次请求的缓存
    contentType: 'application/json;charset=UTF-8',
    error: function (e) {
      console.log(e);
    },
    success: data => {
      console.log(data)
      obj = JSON.parse(obj)
      console.log(obj)
      var str = `
        <form class="content_line" >
          <input value="${data.id}" hidden>
          <p class="content_li cinema_name">${obj.cinemaName}</p>
          <p class="content_li cinema_address">${obj.cinemaAddress}</p>
          <p class="content_li cinema_img"><img src="" alt=""></p>
          <p class="content_li cinema_money">0</p>
          <p class="content_li cinema_num">${obj.cinemaNumber}</p>
          <p class="content_li cinema_email">${obj.cinemaEmail}</p>
          <p class="content_li cinema_operate">
            <button type="reset" onclick="edit_staff(this)" class="edit_button">编辑</button>
            <button type="reset" class="delete_button">删除</button>
          </p>
        </form>`

      parent.append(str)
      $('#float_cinema').css({ "display": "none" })
      $('#new_cinema_form').css({ "display": "none" })
      $('#edit_cinema_form').css({ "display": "none" })

      $('#cancel_new_cinema').on("click", function () {
        $('#float_cinema').css({ "display": "none" })
        $('#new_cinema_form').css({ "display": "none" })
        $('#edit_cinema_form').css({ "display": "none" })
      })

      $('#cancel_edit_cinema').on('click', function () {
        $('#float_cinema').css({ "display": "none" })
        $('#new_cinema_form').css({ "display": "none" })
        $('#edit_cinema_form').css({ "display": "none" })
      })
    }
  })
})


// 功能：编辑影厅部分，取消编辑影厅
$('#cancel_edit_cinema').on('click', function () {
  $('#float_cinema').css({ "display": "none" })
  $('#new_cinema_form').css({ "display": "none" })
  $('#edit_cinema_form').css({ "display": "none" })
})

// 功能：跳出编辑当前影厅弹框
function edit_cinema(t) {
  var parent = $(t).parent().parent()

  // 影厅id

  var id = parent.children()[0].value
  var cinemaName = parent.children()[1].innerHTML
  // var detail_address = parent.children()[2].innerHTML
  var number = parent.children()[5].innerHTML
  var email = parent.children()[6].innerHTML


  $('#float_cinema').css({ "display": "block" })
  $('#new_cinema_form').css({ "display": "none" })
  $('#edit_cinema_form').css({ "display": "block" })

  $('#edit_cinema_id')[0].value = id
  $('#edit_cinema_name')[0].value = cinemaName
  $('#edit_cinema_num')[0].value = number
  $('#edit_cinema_email')[0].value = email

}

// 功能：处理提交编辑影厅表单数据
// 完成
$('#edit_cinema_form').on('submit', e => {
  e.preventDefault()
  const formData = $('#edit_cinema_form').serializeArray()
  var o = {}
  $.each(formData, function () {
    if (o[this.name]) {
      if (!o[this.name].push) {
        o[this.name] = [o[this.name]];
      }
      o[this.name].push(this.value || '');
    } else {
      o[this.name] = this.value || '';
    }
  })
  var county = $('.county-selector-two').children()

  Object.keys(county).forEach(function (key) {
    if (o.county == county[key].innerHTML) {
      o.countyId = county[key].getAttribute("name")
    }
  })

  var obj = {
    "areaId": Number(`${o.countyId}`),
    "cinemaAddress": `${o.province}${o.city}${o.county}${o.detail_address}`,
    "cinemaEmail": `${o.email}`,
    "cinemaName": `${o.name}`,
    "cinemaNumber": `${o.number}`,
    "id": Number(`${o.id}`),
  }

  obj = JSON.stringify(obj)

  var parent = $('.right_content').eq(0)

  $.ajax({
    url: 'http://localhost:8080/editCinema',
    type: 'put',
    data: obj,
    dataType: 'json',
    catch: false,      //清除上次请求的缓存
    contentType: 'application/json;charset=UTF-8',
    success: data => {
      for (let i = 1; i < parent.children().length; i++) {
        let a = parent.children().eq(i)[0]
        if (a.childNodes[1].value == o.id) {
          a.childNodes[3].innerHTML = o.name
          a.childNodes[5].innerHTML = `${o.province}${o.city}${o.county}${o.detail_address}`
          a.childNodes[11].innerHTML = o.number
          a.childNodes[13].innerHTML = o.email
        }
      }

      $('#float_cinema').css({ "display": "none" })
      $('#new_cinema_form').css({ "display": "none" })
      $('#edit_cinema_form').css({ "display": "none" })
    }
  })
})

// 功能：删除电影院
$('body').on("click", '.delete_cinema', function () {
  // 删除按钮所在的一行
  var parent = $(this).parent().parent()
  console.log('parent:', parent)

  let line = parent.eq(0)
  var id_line = line.children().eq(0)
  console.log(id_line[0].value)

  $.ajax({
    url: `http://localhost:8080/delCinemas/${id_line[0].value}/1`,
    type: 'delete',
    dataType: 'json',
    catch: false,      //清除上次请求的缓存
    contentType: 'application/json;charset=UTF-8',
    success: data => {
      console.log('删除成功', data)
      parent.remove()
    }
  })

})


// 点击图片修改文字修改图片
$('body').on("click", '.modify_img', function () {
  console.log('点击到了文字')
})

function previewImage(file) {
  console.log('修改文件')
  var img = document.getElementById('imageshow');
  var selected_img = document.getElementById('selected_img');
  var reader = new FileReader();
  reader.onload = function (evt) {
    // img.src = evt.target.result;
    selected_img.src = evt.target.result;
  }
  reader.readAsDataURL(file.files[0]);

  // stopPropagation();
}


function stopPropagation(e) {
  e = e || window.event;
  if (e.stopPropagation) { //W3C阻止冒泡方法  
    e.stopPropagation();
  } else {
    e.cancelBubble = true; //IE阻止冒泡方法  
  }
}