

var userJsonStr = sessionStorage.getItem('cinema');
userEntity = JSON.parse(userJsonStr);



$('body').on('click', '.movie_box', function () {

  if (this.count === undefined) {
    this.count = 0
  }

  // 选中
  if (this.count % 2 == 0) {
    this.count += 1
    $(this).css({
      'border': '5px solid  rgb(255, 200, 186)', 'border-radius': '10px',
      'overflow': 'hidden',
      // 'name': 'selected'
    })
  }
  // 取消选中
  else {
    this.count += 1
    $(this).css({
      'border': '5px solid  transparent', 'border-radius': '0px',
      'overflow': 'auto',
      // 'name': 'unselected'
    })

  }
})


// 渲染全部可以添加的电影
function GetTime(date) {
  var datee = new Date(date).toJSON();
  return new Date(+new Date(datee) + 8 * 3600 * 1000).toISOString().
    replace(/T/g, ' ').replace(/\.[\d]{3}Z/, '')
}
window.onload = function () {
  $.ajax({
    url: `http://localhost:8080/adminGetMovieByLibrary/${userEntity.cinemaId}`,
    type: 'post',
    dataType: 'json',
    async: false,
    success: data => {
      var parent = $('#content')

      console.log('获取库里没有的电影信息', data)

      var str = ``
      for (var i = 0; i < data.length; i++) {

        // 将电影评分分开显示，整数位直接字符串截取，小数位需要判断是否为空
        let decimal_score = ''
        if (String(data[i].movieScore).substring(2, 3) == '') {
          decimal_score = '0';
        } else {
          decimal_score = String(data[i].movieScore).substring(2, 3)
        }
        if (data[i].id != null) {
          str += `
          <div class="movie_box" id="${data[i].id}">
            <img class="film_img"
              src="${data[i].movieHead}" alt="电影图片" >
            <div class="film_intro">
              <input value="${data[i].id}" type="text" hidden>
              <p><span class="film_intro_name">${data[i].movieName}</span><span class="film_intro_score"><big>${String(data[i].movieScore).substring(0, 1)}</big>.${decimal_score} </span></p>
              <p><span class="film_title">类型：</span><span class="film_sort_detail">${data[i].movieType}</span></p>
              <p><span class="film_title">导演：</span><span class="film_actor_detail"></span></p>
              <p><span class="film_title">上映时间：</span><span class="film_time_detail">${GetTime(data[i].movieStart).substring(0, 10)}</span></p>
            </div>
          </div>`
        }

      }

      parent.empty()
      parent.append(`${str}`)

    }
  })

  $('#submit_new_movies').on('click', function () {
    var id_list = $('.movie_box')

    var oData = "["

    Object.keys(id_list).forEach(function (key) {
      if (key < id_list.length) {
        if (id_list[key].style.border == '5px solid rgb(255, 200, 186)') {
          let obj = `{"cinemaId": ${userEntity.cinemaId},"movieId": ${Number(id_list[key].id)} },`
          oData += obj
        }
      }

    })
    oData = oData.substring(0, oData.length - 1)
    oData += ']'
    console.log(oData)


    $.ajax({
      url: 'http://localhost:8080/adminAddMovies',
      type: 'POST',
      data: oData,
      dataType: 'json',
      catch: false,      //清除上次请求的缓存、
      contentType: 'application/json;charset=UTF-8',
      // async: false,
      success: data => {
        console.log(data)
        window.location.href = "../html/administrator.html"

      }
    })

  })

}

