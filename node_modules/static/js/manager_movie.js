// 设置时间
function GetTime(date) {
  var datee = new Date(date).toJSON();
  return new Date(+new Date(datee) + 8 * 3600 * 1000).toISOString().
    replace(/T/g, ' ').replace(/\.[\d]{3}Z/, '')
}

// 点击电影跳到电影详情
var movieId
var movieName = ''
var plan = ''


$('body').on("click", '.movie_box', function () {

  var arr = ($(this).children().eq(1)).children()
  console.log(arr)
  var id = arr[0].value
  var name = arr[1].value
  var score = arr[2].value
  var time = arr[3].value
  var type = arr[4].value
  var timeStart = arr[5].value
  var area = arr[6].value
  var wantLook = arr[7].value
  var movieHead = arr[8].value
  var status = arr[9].value
  var brief = arr[10].value

  var str = {
    "id": id,
    "name": name,
    "score": score,
    "time": time,
    "type": type,
    "timeStart": timeStart,
    "area": area,
    "wantLook": wantLook,
    "movieHead": movieHead,
    "status": status,
    "brief": brief
  }
  sessionStorage.setItem('movieDetail', JSON.stringify(str));
  window.location.href = '../html/movie_detail.html'
})

// 删除经理管理处的电影
// 删除没用
// $('body').on("click", '.delete_movie', function () {
//   var parent = $(this).parent()

//   let line = parent.eq(0)[0]
//   // console.log(parent.eq(0)[0])
//   // console.log(line.id)
//   $.ajax({
//     url: `http://localhost:8080/AdminDelMovie/${line.id}/1`,
//     type: 'delete',
//     dataType: 'json',
//     catch: false,      //清除上次请求的缓存
//     contentType: 'application/json;charset=UTF-8',
//     success: data => {
//       // console.log(data)

//       // console.log('删除成功')
//       parent.remove()
//     }
//   })
//   return false
// })


// 功能：新增电影弹框，只添加简单的文字信息new_movie

$('#new_movie').on("click", function () {
  $('#float_movie').css({ "display": "block" })
  $('#new_movie_form').css({ "display": "block" })
  $('#edit_movie_form').css({ "display": "none" })
})


// 功能：取消新增影厅弹框

$('#cancel_new_movie').on("click", function () {
  $('#float_movie').css({ "display": "none" })
  $('#new_movie_form').css({ "display": "none" })
  $('#edit_movie_form').css({ "display": "none" })
})


// 功能：提交新增影厅表单

$('#new_movie_form').on('submit', e => {
  e.preventDefault()
  const formData = $('#new_movie_form').serializeArray()
  var o = {}
  $.each(formData, function () {
    if (o[this.name]) {
      if (!o[this.name].push) {
        o[this.name] = [o[this.name]];
      }
      o[this.name].push(this.value || '');
    } else {
      o[this.name] = this.value || '';
    }
  })

  console.log(o)
  var parent = $('.right_content').eq(1)


  let obj = {
    "movieArea": "中国大陆",
    "movieBrief": `${o.brief}`,
    "movieMinute": Number(`${o.time}`),
    "movieName": `${o.name}`,
    "movieStart": new Date(GetTime(`${o.start_time}`)),
    "movieStatus": Number(`${o.status}`),
    "movieType": `${o.sort}`,
    "movieScore": 0,
    "movieHead": 'https://p0.meituan.net/moviemachine/b99384cf1eacb139fde0509af424af6623037.png@128w_170h_1e_1c'
  }
  console.log(obj)
  obj = JSON.stringify(obj)
  console.log(obj)

  $.ajax({
    url: 'http://localhost:8080/ManageAddMovie',
    type: 'POST',
    data: obj,
    dataType: 'json',
    catch: false,      //清除上次请求的缓存
    contentType: 'application/json;charset=UTF-8',
    error: function (e) {
      console.log(e);
    },
    success: data => {
      console.log(data)
      let type
      obj = JSON.parse(obj)
      var str = `
          <div class="movie_box" id="${data}">
            <img class="film_img"
              src="${obj.movieHead}" alt="电影图片" />
            <div class="film_intro">
              <p><span class="film_intro_name">${obj.movieName}</span><span class="film_intro_score"><big>0</big>.0</span></p>
              <p><span class="film_title">类型：</span><span class="film_sort_detail">${obj.movieType}</span></p>
              <p><span class="film_title">导演：</span><span class="film_actor_detail"></span></p>
              <p><span class="film_title">上映时间：</span><span class="film_time_detail">${GetTime(obj.start_time).substring(0, 10)}</span></p>
            </div>
            <button class="delete_movie">删除电影</button>
          </div>`

      parent.append(str)
      $('#float_movie').css({ "display": "none" })
      $('#new_movie_form').css({ "display": "none" })
      $('#edit_movie_form').css({ "display": "none" })


      // 功能：取消新增影厅弹框

      $('#cancel_new_movie').on("click", function () {
        $('#float_movie').css({ "display": "none" })
        $('#new_movie_form').css({ "display": "none" })
        $('#edit_movie_form').css({ "display": "none" })
      })

    }
  })
})

