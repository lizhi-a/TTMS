
// 所属板块：管理影厅
// 功能：修改css
//      使用动画所用的js
//      除去提交form表单所用js


var userJsonStr = sessionStorage.getItem('cinema');
userEntity = JSON.parse(userJsonStr);



// 功能：点击新增影厅按钮，出现新增影厅的弹框

$('#new_hall').on("click", function () {
  $('#float_box').css({ "display": "block" })
  $('#new_hall_form').css({ "display": "block" })
  $('#edit_hall_form').css({ "display": "none" })
})


// 功能：取消新增影厅弹框

$('#cancel_new_hall').on("click", function () {
  $('#float_box').css({ "display": "none" })
  $('#new_hall_form').css({ "display": "none" })
  $('#edit_hall_form').css({ "display": "none" })
})

// 功能：提交新增影厅表单

$('#new_hall_form').on('submit', e => {
  e.preventDefault()
  const formData = $('#new_hall_form').serializeArray()
  var o = {}
  $.each(formData, function () {
    if (o[this.name]) {
      if (!o[this.name].push) {
        o[this.name] = [o[this.name]];
      }
      o[this.name].push(this.value || '');
    } else {
      o[this.name] = this.value || '';
    }
  })

  var parent = $('.all_hall').eq(1)

  let obj = {
    "cinemaId": `${userEntity.cinemaId}`,
    "hallName": `${o.hallName}`,
    "movieType": `${o.movieType}`,
    "seatColumn": Number(o.seatLine),
    "seatLine": Number(o.seatColumn)
  }
  obj = JSON.stringify(obj)
  // console.log(obj)

  $.ajax({
    url: 'http://localhost:8080/addHall',
    type: 'POST',
    data: obj,
    dataType: 'json',
    catch: false,      //清除上次请求的缓存
    contentType: 'application/json;charset=UTF-8',
    error: function (e) {
      console.log(e);
    },
    success: data => {
      console.log(data)
      var str = `
          <form class=\"hall\">
              <input hidden value="${data}"></input>
              <p class=\"hall_name hall_p\">${o.hallName}</p>
              <p class="hall_sort hall_p\">${o.movieType}</p>
              <p class=\"hall_line hall_p\">${o.seatLine}</p>
              <p class=\"hall_column hall_p\">${o.seatColumn}</p>
              <p class="hall_operate">
              <button type=\"reset\" onclick="edit_hall(this)" class=\"edit_hall\">编辑</button>
              <button type=\"reset\" class=\"delete_hall\">删除</button>
              </p>
          </form>`

      parent.append(str)
      $('#float_box').css({ "display": "none" })
      $('#new_hall_form').css({ "display": "none" })
      $('#edit_hall_form').css({ "display": "none" })


      $('#cancel_edit_hall').on('click', function () {
        $('#float_box').css({ "display": "none" })
        $('#new_hall_form').css({ "display": "none" })
        $('#edit_hall_form').css({ "display": "none" })
      })
    }
  })
})

// 功能：点击影厅删除按钮，删除影厅
$('body').on("click", '.delete_hall', function () {
  // 删除按钮所在的一行
  var parent = $(this).parent().parent()

  let line = parent.eq(0)
  var id_line = line.children().eq(0)

  $.ajax({
    url: `http://localhost:8080/delHall/${id_line[0].value}/${userEntity.cinemaId}/1`,
    type: 'delete',
    dataType: 'json',
    catch: false,      //清除上次请求的缓存
    contentType: 'application/json;charset=UTF-8',
    success: data => {
      console.log(data)
      console.log('删除成功')
      parent.remove()
    }
  })
})


// 功能：编辑影厅部分，取消编辑影厅
$('#cancel_edit_hall').on('click', function () {
  $('#float_box').css({ "display": "none" })
  $('#new_hall_form').css({ "display": "none" })
  $('#edit_hall_form').css({ "display": "none" })
})

// 功能：跳出编辑当前影厅弹框
function edit_hall(t) {
  var parent = $(t).parent().parent()

  // 影厅id
  var id = parent.children()[0].value
  var hallName = parent.children()[1].innerHTML
  var movieType = parent.children()[2].innerHTML
  var seatLine = parent.children()[3].innerHTML
  var seatColumn = parent.children()[4].innerHTML


  $('#float_box').css({ "display": "block" })
  $('#new_hall_form').css({ "display": "none" })
  $('#edit_hall_form').css({ "display": "block" })

  $('#edit_id')[0].value = id
  $('#edit_hallName')[0].value = hallName
  $('#edit_seatLine')[0].value = seatLine
  $('#edit_seatColumn')[0].value = seatColumn

}

// 功能：处理提交编辑影厅表单数据
// 完成
$('#edit_hall_form').on('submit', e => {
  e.preventDefault()
  const formData = $('#edit_hall_form').serializeArray()
  var o = {}
  $.each(formData, function () {
    if (o[this.name]) {
      if (!o[this.name].push) {
        o[this.name] = [o[this.name]];
      }
      o[this.name].push(this.value || '');
    } else {
      o[this.name] = this.value || '';
    }
  })
  var str = `
    <form action="" class="hall">
      <input hidden value="${o.id}"></input>
      <p class="hall_name hall_p">${o.hallName}</p>
      <p class="hall_sort hall_p">${o.movieType}</p>
      <p class="hall_line hall_p">${o.seatLine}</p>
      <p class="hall_column hall_p">${o.seatColumn}</p>
      <p class="hall_operate">
        <button type="reset" class="edit_hall">编辑</button>
        <button type="reset" class="delete_hall">删除</button>
      </p>
    </form>`

  var parent = $('.all_hall').eq(1)

  var obj = {
    "cinemaId": `${userEntity.cinemaId}`,
    "hallName": `${o.hallName}`,
    "id": `${o.id}`,
    "movieType": `${o.movieType}`,
    "seatColumn": `${o.seatColumn}`,
    "seatLine": `${o.seatLine}`
  }
  obj.id = Number(obj.id)
  var id = obj.id
  obj.seatColumn = Number(obj.seatColumn)
  obj.seatLine = Number(obj.seatLine)
  obj = JSON.stringify(obj)
  console.log(obj)

  $.ajax({
    url: 'http://localhost:8080/editHall',
    type: 'put',
    data: obj,
    dataType: 'json',
    catch: false,      //清除上次请求的缓存
    contentType: 'application/json;charset=UTF-8',
    success: data => {
      for (let i = 1; i < parent.children().length; i++) {
        let a = parent.children().eq(i)[0]
        if (a.childNodes[1].value == id) {
          a.childNodes[3].innerHTML = o.hallName
          a.childNodes[5].innerHTML = o.movieType
          a.childNodes[7].innerHTML = o.seatLine
          a.childNodes[9].innerHTML = o.seatColumn
        }
      }

      $('#float_box').css({ "display": "none" })
      $('#new_hall_form').css({ "display": "none" })
      $('#edit_hall_form').css({ "display": "none" })
    }
  })
})