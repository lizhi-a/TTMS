
function GetTime(date) {
  var datee = new Date(date).toJSON();
  return new Date(+new Date(datee) + 8 * 3600 * 1000).toISOString().
    replace(/T/g, ' ').replace(/\.[\d]{3}Z/, '')
}
/*
获取session的信息
*/
var userJsonStr = sessionStorage.getItem('movieDetail')
var userEntity = JSON.parse(userJsonStr)

var id = userEntity.id
window.onload = function () {

  $('.movieHead')[0].src = userEntity.movieHead
  $('.film_name')[0].innerHTML = userEntity.name
  $('.film_line')[0].innerHTML = `${userEntity.type} / ${userEntity.score}分`
  $('.film_line')[1].innerHTML = `${userEntity.time} 分钟`
  $('.film_line')[2].innerHTML = `${GetTime(userEntity.timeStart).substring(0, 11)}${userEntity.area}上映`
  $('.film_line')[3].innerHTML = `<img src="../static/image/love.png" alt="">${userEntity.wantLook} 人想看`

  var status = userEntity.status
  var movieId = userEntity.id


  $.ajax({
    url: `http://localhost:8080/getSpecificMovie/${status}/${movieId}`,
    type: 'get',
    dataType: 'json',
    async: false,
    contentType: 'application/json;charset=UTF-8',
    success: data => {
      console.log(data)
      var directList = data.directorList
      var movieActorList = data.movieActorList
      var producerList = data.producerList
      var writerList = data.writerList
      var movieVideoList = data.movieVideoList

      // 导演
      var parent = $('#direct_list')
      var str = `<p class="crew_sort iconfont">&#xe75f;导演： </p>`
      for (let i = 0; i < directList.length; i++) {
        str += `
        <div class="crew_box">
          <img class="crew_icon"
            src="${directList[i].directorPicture}" alt="">
          <div class="crew_describe">
            <p class="crew_name">${directList[i].directorName}</p>
          </div>
        </div>`
      }
      parent.empty()
      parent.append(str)

      // 演员
      parent = $('#actor_list')
      str = `<p class="crew_sort iconfont">&#xe75f;演员： </p>`
      for (let i = 0; i < movieActorList.length; i++) {
        str += `
        <div class="crew_box">
          <img class="crew_icon"
            src="${movieActorList[i].actorPicture}" alt="">
          <div class="crew_describe">
            <p class="crew_name">${movieActorList[i].actorName}</p>
            <p class="crew_portray">${movieActorList[i].roleName}</p>
          </div>
        </div>`
      }
      parent.empty()
      parent.append(str)

      // 编剧
      parent = $('#writer_list')
      str = `<p class="crew_sort iconfont">&#xe75f;编剧： </p>`
      for (let i = 0; i < writerList.length; i++) {
        str += `<div class="crew_box">
          <img class="crew_icon"
            src="${writerList[i].screenwriterPicture}" alt="">
          <div class="crew_describe">
            <p class="crew_name">${writerList[i].screenwriterName}</p>
          </div>
        </div>`
      }
      parent.empty()
      parent.append(str)

      // 制片人
      parent = $('#producer_list')
      str = `<p class="crew_sort iconfont">&#xe75f;制片人：</p>`
      for (let i = 0; i < producerList.length; i++) {
        str += `
        <div class="crew_box" >
          <img class="crew_icon"
            src="${producerList[i].producerPicture}" alt="">
            <div class="crew_describe">
              <p class="crew_name">${producerList[i].producerName}</p>
            </div>
        </div>`
      }
      parent.empty()
      parent.append(str)


      parent = $('#video_list')
      str = ``
      for (let i = 0; i < movieVideoList.length; i++) {
        str += `<div class="bo">
            <img src="${movieVideoList[i].movieVideo}" alt="">
              <div class="ms">${movieVideoList[i].videoTitle}</div>
            <br>
          </div>`
      }
      parent.empty()
      parent.append(str)

    }
  })


  // 功能：编辑电影弹框，只添加简单的文字信息new_movie

  $('#edit_movie_intro').on('click', function () {
    console.log(this)


    $('#float_movie').css({ "display": "block" })
    $('#edit_movie_form').css({ "display": "block" })

    $('#edit_movie_name')[0].value = `${userEntity.name}`

    $('#edit_movie_during')[0].value = userEntity.time
    $('#edit_movie_type')[0].value = userEntity.type
    $('#edit_movie_brief')[0].value = userEntity.brief

  })


  // 功能：取消编辑影厅弹框

  $('#cancel_edit_movie').on("click", function () {
    $('#float_movie').css({ "display": "none" })
    $('#edit_movie_form').css({ "display": "none" })
  })

  // 编辑表单提交事件
  $('#edit_movie_form').on('submit', e => {
    e.preventDefault()
    const formData = $('#edit_movie_form').serializeArray()
    var o = {}
    $.each(formData, function () {
      if (o[this.name]) {
        if (!o[this.name].push) {
          o[this.name] = [o[this.name]];
        }
        o[this.name].push(this.value || '');
      } else {
        o[this.name] = this.value || '';
      }
    })

    // console.log(o)

    var obj = {
      "id": Number(userEntity.id),
      "movieBrief": `${o.brief}`,
      "movieMinute": Number(`${o.time}`),
      "movieName": `${o.name}`,
      "movieStart": new Date(`${o.start_time}`),
      "movieStatus": Number(`${o.status}`),
      "movieType": `${o.sort}`,
    }

    // console.log(obj)
    obj = JSON.stringify(obj)

    $.ajax({
      url: 'http://localhost:8080/editMovie',
      type: 'put',
      data: obj,
      dataType: 'json',
      catch: false,      //清除上次请求的缓存
      contentType: 'application/json;charset=UTF-8',
      success: data => {
        console.log(data)

        $('.film_name')[0].innerHTML = o.name
        $('.film_line')[0].innerHTML = `${o.sort} / ${userEntity.score}分`
        $('.film_line')[1].innerHTML = `${o.time} 分钟`
        $('.film_line')[2].innerHTML = `${(o.start_time).substring(0, 11)}${userEntity.area}上映`
        $('.film_line')[3].innerHTML = `<img src="../static/image/love.png" alt="">${userEntity.wantLook} 人想看`

        var str = {
          "id": userEntity.id,
          "name": o.name,
          "score": userEntity.score,
          "time": o.time,
          "type": o.sort,
          "timeStart": o.start_time,
          "area": userEntity.area,
          "wantLook": userEntity.wantLook,
          "movieHead": userEntity.movieHead,
          "status": o.status,
          "brief": o.brief
        }
        sessionStorage.setItem('movieDetail', JSON.stringify(str));

        $('#float_movie').css({ "display": "none" })
        $('#edit_movie_form').css({ "display": "none" })
      }
    })

  })

}

