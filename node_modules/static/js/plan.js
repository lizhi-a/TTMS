
// // 所属板块：排片管理
// // 功能：修改css
// //      使用动画所用的js
// //      除去提交form表单所用js
// 功能：点击新增计划按钮，出现新增计划的弹框


var time_to_sec = function (time) {
  var s = '';

  // time.split(':')
  var hour = time.split(':')[0];
  var min = time.split(':')[1];
  var sec = time.split(':')[2];

  s = Number(hour * 3600) + Number(min * 60) + Number(sec);

  return s;
}

/**
     * 将秒数换成时分秒格式
     * 作者：龙周峰
     */
function formatSeconds(value) {
  var secondTime = parseInt(value);// 秒
  var minuteTime = 0;// 分
  var hourTime = 0;// 小时
  if (secondTime > 60) {//如果秒数大于60，将秒数转换成整数
    //获取分钟，除以60取整数，得到整数分钟
    minuteTime = parseInt(secondTime / 60);
    //获取秒数，秒数取佘，得到整数秒数
    secondTime = parseInt(secondTime % 60);
    //如果分钟大于60，将分钟转换成小时
    if (minuteTime > 60) {
      //获取小时，获取分钟除以60，得到整数小时
      hourTime = parseInt(minuteTime / 60);
      //获取小时后取佘的分，获取分钟除以60取佘的分
      minuteTime = parseInt(minuteTime % 60);
    }
  }

  if (minuteTime < 10) minuteTime = '0' + minuteTime
  if (secondTime < 10) secondTime = '0' + secondTime
  if (hourTime < 10) hourTime = '0' + hourTime
  result = `${hourTime}:${minuteTime}:${secondTime}`;
  return result;
}

var userJsonStr = sessionStorage.getItem('cinema');
userEntity = JSON.parse(userJsonStr);


function GetTime(date) {
  var datee = new Date(date).toJSON();
  return new Date(+new Date(datee) + 8 * 3600 * 1000).toISOString().
    replace(/T/g, ' ').replace(/\.[\d]{3}Z/, '')
}

// 点击电影跳到演出计划
var movieId
var movieName = ''
var movieMinute = ''

var plan = ''
$('body').on("click", '.plan_box', function () {

  // 该电影的id
  movieId = $(this)[0].id
  movieMinute = $(this)[0].getAttribute("src")
  movieName = $(this).children()[1]
  // console.log(movieName)
  movieName = ((movieName.childNodes[3]).childNodes[0]).innerHTML

  $.ajax({
    url: `http://localhost:8080/getPlan/${movieId}/${userEntity.cinemaId}`,
    type: 'get',
    dataType: 'json',
    catch: false,      //清除上次请求的缓存
    async: false,
    // contentType: 'application/json;charset=UTF-8',
    success: data => {
      console.log('该电影的演出计划', data)

      // 该页面全局获取信息
      plan = data

      // 清空盒子内所有内容
      $('#file_schedule').empty()

      // 获取所有分段日期
      let date_list = []
      Object.keys(data).forEach(function (key) {
        let date = (GetTime(key)).substring(5, 10)
        date = date.replace("-", "月");
        // if (data[key][0].hall != null) {
        date_list.push(date)
        // }
      })

      // 将头部追加进去
      var str = `
          <div id="plan_detail_header">
            <a href="../html/administrator.html">
              <img src="../static/image/back.png" alt=""> 返回 </a>

            <button id="low_price">最低票价</button>
            <button id="add_plan">新增</button>
          </div>
          <div id="plan_date_box">
          </div>`
      $('#file_schedule').append(`${str}`)

      // 将date_list有的日期加进去
      str = ``
      for (let i = 0; i < date_list.length; i++) {
        str += `<p class="plan_date">${date_list[i]}</p>`
      }

      $('#plan_date_box').append(`${str}`)

      $('.plan_date').css({ "background-color": "white", "color": "#4299e1" })
      let current_date = document.getElementsByClassName('plan_date')[0]
      current_date.style.backgroundColor = '#4299e1'
      current_date.style.color = 'white'


      // 添加列表项
      str = ` 
        <div class="all_hall" id="plan_list">
          <div class="hall">
            <p class="hall_name movie_title_name">电影名称</p>
            <p class="hall_sort movie_title_img">播放影厅</p>
            <p class="hall_line movie_title_video">上映时间</p>
            <p class="hall_column movie_title_intro">开始时间</p>
            <p class="hall_column movie_title_sort">票价</p>
            <p class="hall_operate staff_operator">操作</p>
          </div>
        </div>`
      $('#file_schedule').append(`${str}`)

      Object.keys(plan).forEach(function (key) {
        if ((GetTime(key)).substring(5, 10).replace("-", "月") == current_date.innerHTML) {
          str = ``
          for (let i = 0; i < plan[key].length; i++) {
            if (plan[key][i].hall != null) {
              str += `
              <form action="" class="hall">
                <input name="id" value="${plan[key][i].id}" hidden/>
                <p class="hall_name movie_title_name">${((plan[key][i]).movie).movieName}</p>
                <p class="hall_sort movie_title_img">${(plan[key][i].hall).hallName}</p>
                <p class="hall_line movie_title_video">${GetTime(plan[key][i].planDate).substring(0, 10)}</p>
                <p class="hall_column movie_title_intro">${GetTime(plan[key][i].movieStartTime).substring(11, 19)}</p>
                <p class="hall_column movie_title_sort">${plan[key][i].ticketMoney}</p>
                <p class="hall_operate staff_operator">
                  <button type="reset" onclick="edit_order(this)" class="edit_order">编辑</button>
                  <button type="reset" class="delete_order">删除</button>
                </p>
              </form>`
            }

          }
          $('#plan_list').append(`${str}`)
        }
      })


    }
  })

  // 功能：弹出新增计划弹框
  $('#add_plan').on("click", function () {
    $('#float_plan').css({ "display": "block" })
    $('#new_plan_form').css({ "display": "block" })
    $('#edit_plan_form').css({ "display": "none" })

    $.ajax({
      url: `http://localhost:8080/getHalls/${userEntity.cinemaId}`,
      type: 'get',
      dataType: 'json',
      catch: false,
      success: data => {
        $('#new_plan_hall').empty()
        let str = ``
        Object.getOwnPropertyNames(data).forEach(function (key) {
          if (data[key].id != null) {
            str += `<option name="${data[key].id}">${data[key].hallName}</option>`
          }
        })

        $('#new_plan_hall').append(str)
      }
    })


    let moviesSecond = movieMinute * 60
    var planTime = []
    let startTime = '08:00:00'
    let start = '08:00:00'

    let end = formatSeconds(Number(moviesSecond) + time_to_sec(start) + 1800)

    let parent = $('#plan_time')
    planTime[0] = {
      start: '08:00:00',
      end: '10:30:00'
    }
    let str = `
        <div class="plan_time_box">
          <p class="plan_time_p">${planTime[0].start}-${end}</p>
          <input class="plan_time_input" type="text" placeholder="请输入该演出计划票价">
        </div>`
    // 将有的时间段加进去
    for (let i = 1; i < 8; i++) {
      if (Number(moviesSecond) + time_to_sec(planTime[i - 1].end) + 1800 <= 90000) {

        let obj = {
          start: planTime[i - 1].end,
          end: formatSeconds(Number(moviesSecond) + time_to_sec(planTime[i - 1].end) + 1800)
        }

        planTime[i] = obj
        str += `<div class="plan_time_box">
          <p class="plan_time_p">${obj.start}-${obj.end}</p>
          <input class="plan_time_input" type="text" placeholder="请输入该演出计划票价">
        </div>`
      }
      else break;
    }
    parent.empty()
    parent.append(str)

  })

  // 功能：取消新增计划弹框
  $('#cancel_new_plan').on("click", function () {
    $('#float_plan').css({ "display": "none" })
    $('#new_plan_form').css({ "display": "none" })
    $('#edit_plan_form').css({ "display": "none" })
  })


  // 功能：点击电影的最低票价按钮，出现弹框
  $('#low_price').on("click", function () {
    $('#price_pop').css({ "display": "block" })
    $('#price_pop_form').css({ "display": "block" })
  })

  // 功能：取消最低票价弹框
  $('#cancel_price_pop').on("click", function () {
    $('#price_pop').css({ "display": "none" })
    $('#price_pop_form').css({ "display": "none" })
  })


  // 功能:设置当前电影的最低票价
  $('#price_pop_form').on('submit', e => {
    e.preventDefault()
    const formData = $('#price_pop_form').serializeArray()
    var o = {}
    $.each(formData, function () {
      if (o[this.name]) {
        if (!o[this.name].push) {
          o[this.name] = [o[this.name]];
        }
        o[this.name].push(this.value || '');
      } else {
        o[this.name] = this.value || '';
      }
    })

    console.log(o)

    $.ajax({
      url: `http://localhost:8080/setLowMoney/${o.low_price}/${userEntity.cinemaId}/${movieId}`,
      type: 'post',
      dataType: 'json',
      catch: false,      //清除上次请求的缓存
      contentType: 'application/json;charset=UTF-8',
      success: data => {
        console.log(data)

        $('#price_pop').css({ "display": "none" })
        $('#price_pop_form').css({ "display": "none" })
      }
    })

  })
})


// 点击时间段变色
$('body').on("click", '.plan_time_p', function () {

  if (this.count === undefined) {
    this.count = 0
  }

  // 选中
  if (this.count % 2 == 0) {
    this.count += 1
    $(this).css({
      'border': '1px solid  transparent',
      'backgroundColor': '#4299e1',
      'color': 'white'
    })
  }// 取消选中
  else {
    this.count += 1
    $(this).css({
      'border': '1px solid rgb(221, 221, 221)',
      'backgroundColor': 'white',
      'color': '#4299e1',
    })

  }
})


// 点击日期跳转计划
$('body').on("click", '.plan_date', function () {

  $('.plan_date').css({ "background-color": "white", "color": "#4299e1" })
  $(this).css({ "background-color": "#4299e1", "color": "white" })


  $('#plan_list').empty()
  // 获取所有分段日期
  var date = this.innerHTML

  Object.keys(plan).forEach(function (key) {
    if ((GetTime(key)).substring(5, 10).replace("-", "月") == date) {
      console.log(date, plan[key])
      str = `
              <div class="all_hall" id="plan_list">
                <div class="hall">
                  <p class="hall_name movie_title_name">电影名称</p>
                  <p class="hall_sort movie_title_img">播放影厅</p>
                  <p class="hall_line movie_title_video">上映时间</p>
                  <p class="hall_column movie_title_intro">开始时间</p>
                  <p class="hall_column movie_title_sort">票价</p>
                  <p class="hall_operate staff_operator">操作</p>
                </div>
              </div>`
      for (let i = 0; i < plan[key].length; i++) {
        if (plan[key][i].hall != null) {
          // console.log(plan[key][i])
          str += `
                  <form action="" class="hall">
                <input name="id" value="${plan[key][i].id}" hidden/>
                    <p class="hall_name movie_title_name">${((plan[key][i]).movie).movieName}</p>
                    <p class="hall_sort movie_title_img">${(plan[key][i].hall).hallName}</p>
                    <p class="hall_line movie_title_video">${GetTime(plan[key][i].planDate).substring(0, 10)}</p>
                    <p class="hall_column movie_title_intro">${GetTime(plan[key][i].movieStartTime).substring(11, 19)}</p>
                    <p class="hall_column movie_title_sort">${plan[key][i].ticketMoney}</p>
                    <p class="hall_operate staff_operator">
                      <button type="reset" onclick="edit_order(this)" class="edit_order">编辑</button>
                      <button type="reset" class="delete_order">删除</button>
                    </p>
                  </form>`
        }
      }

      $('#plan_list').append(`${str}`)
    }
  })

})


// 功能：编辑演出计划部分，取消编辑演出计划
$('#cancel_edit_plan').on('click', function () {
  $('#float_plan').css({ "display": "none" })
  $('#new_plan_form').css({ "display": "none" })
  $('#edit_plan_form').css({ "display": "none" })
})

// 功能：跳出编辑当前演出计划弹框
function edit_order(t) {
  var parent = $(t).parent().parent()

  $.ajax({
    url: `http://localhost:8080/getHalls/${userEntity.cinemaId}`,
    type: 'get',
    dataType: 'json',
    catch: false,
    success: data => {
      $('#plan_edit_hall').empty()
      let str = ``
      Object.getOwnPropertyNames(data).forEach(function (key) {
        if (data[key].id != null) {
          str += `<option name="${data[key].id}">${data[key].hallName}</option>`
        }
      })

      $('#plan_edit_hall').append(str)

      // 影厅id
      var id = parent.children()[0].value
      var start_time = parent.children()[4].innerHTML
      var price = parent.children()[5].innerHTML

      $('#float_plan').css({ "display": "block" })
      $('#new_plan_form').css({ "display": "none" })
      $('#edit_plan_form').css({ "display": "block" })

      $('#edit_plan_id')[0].value = id
      $('#edit_plan_start')[0].value = start_time
      $('#edit_price')[0].value = price
    }
  })

}

// 功能：提交编辑的表单
$('#edit_plan_form').on('submit', e => {
  e.preventDefault()
  const formData = $('#edit_plan_form').serializeArray()
  var o = {}
  $.each(formData, function () {
    if (o[this.name]) {
      if (!o[this.name].push) {
        o[this.name] = [o[this.name]];
      }
      o[this.name].push(this.value || '');
    } else {
      o[this.name] = this.value || '';
    }
  })

  // 获取演出厅
  var hallName = ''
  for (let i = 0; i < $('#plan_edit_hall')[0].length; i++) {
    if (($('#plan_edit_hall')[0])[i].selected == true) {
      hallName = ($('#plan_edit_hall')[0])[i].outerText
    }
  }
  o.hallName = hallName

  // 获取日期
  var plan_date = $('.plan_date')
  var length = plan_date.length
  Object.getOwnPropertyNames(plan_date).forEach(function (key) {
    if (length > 0) {
      length -= 1
      if (plan_date[key].style.color == 'white') {
        // console.log(plan_date[key])
        o.date = plan_date[key].innerHTML
      }
    }
  })

  o.date = (o.date).replace("月", "-")
  o.date = '2021-' + o.date
  o.end_time = o.date + ' ' + o.end_time
  o.start_time = o.date + ' ' + o.start_time
  o.id = Number(o.id)
  o.price = Number(o.price)

  o.hallId = ''
  o.hallName = ''
  for (let i = 0; i < $('#plan_edit_hall')[0].length; i++) {
    if (($('#plan_edit_hall')[0])[i].selected == true) {
      o.hallName = ($('#plan_edit_hall')[0])[i].outerText
      o.hallId = ($('#plan_edit_hall')[0])[i].getAttribute("name")
    }
  }
  console.log(o)

  // var obj = {
  //   "cinemaMovieId": Number(`${movieId}`),
  //   "hall": {
  //     "cinemaId": `${userEntity.cinemaId}`,
  //     "id": Number(`${o.hallId}`),
  //   },
  //   "id": Number(`${o.id}`),
  //   "movieEndTime": new Date(`${o.end_time}`),
  //   "movieStartTime": new Date(`${o.start_time}`),
  //   "planDate": new Date(`${o.date}`),
  //   "ticketMoney": Number(`${o.price}`)
  // }

  var obj = {
    "hallId": Number(`${o.hallId}`),
    "id": Number(`${o.id}`),
    "movieEndTime": new Date(`${o.end_time}`),
    "movieStartTime": new Date(`${o.start_time}`),
    "planDate": new Date(`${o.date}`),
    "ticketMoney": Number(`${o.price}`)
  }


  obj = JSON.stringify(obj)
  console.log(obj)

  $.ajax({
    url: 'http://localhost:8080/editPlan',
    type: 'put',
    data: obj,
    dataType: 'json',
    catch: false,      //清除上次请求的缓存
    contentType: 'application/json;charset=UTF-8',
    success: data => {
      // console.log(data)
      let parent = $('.all_hall').eq(3)

      var element = $('.right_box')[3];
      $(element).css("display", "block");

      for (let i = 1; i < parent.children().length; i++) {
        let a = parent.children().eq(i)[0]
        if (a.childNodes[1].value == o.id) {
          console.log(a)
          console.log(a.childNodes)
          a.childNodes[5].innerHTML = o.hallName
          a.childNodes[9].innerHTML = (o.start_time).substring(11,)
          a.childNodes[11].innerHTML = o.price
        }
      }


      $('#float_plan').css({ "display": "none" })
      $('#new_plan_form').css({ "display": "none" })
      $('#edit_plan_form').css({ "display": "none" })
    }
  })

})

// 功能：提交新增表单

$('#new_plan_form').on('submit', e => {
  e.preventDefault()
  const formData = $('#new_plan_form').serializeArray()
  var o = {}
  $.each(formData, function () {
    if (o[this.name]) {
      if (!o[this.name].push) {
        o[this.name] = [o[this.name]];
      }
      o[this.name].push(this.value || '');
    } else {
      o[this.name] = this.value || '';
    }
  })

  // 获取演出厅
  var hallName = ''
  var hallId = 0
  for (let i = 0; i < $('#new_plan_hall')[0].length; i++) {
    if (($('#new_plan_hall')[0])[i].selected == true) {
      hallName = ($('#new_plan_hall')[0])[i].outerText
      hallId = ($('#new_plan_hall')[0])[i].getAttribute("name")
    }
  }
  o.hallName = hallName
  o.hallId = hallId
  o.planDate = (o.start_time).substring(0, 10)

  // 获取日期
  var plan_date = $('.plan_date')
  var length = plan_date.length
  Object.getOwnPropertyNames(plan_date).forEach(function (key) {
    if (length > 0) {
      length -= 1
      if (plan_date[key].style.color == 'white') {
        o.date = plan_date[key].innerHTML
      }
    }
  })

  var plan_time_p = $('.plan_time_p')
  var arr = '['
  var length = plan_time_p.length
  Object.getOwnPropertyNames(plan_time_p).forEach(function (key) {
    if (length > 0) {
      length -= 1
      if (plan_time_p[key].style.color == 'white') {

        let plan_time_input = (plan_time_p[key].nextSibling).nextSibling

        let time = plan_time_p[key].innerHTML
        let movieStartTime = `${o.planDate} ${time.substring(0, 8)}`
        let movieEndTime = `${o.planDate} ${time.substring(9, 19)}`
        // console.log(time)
        // console.log(movieStartTime)

        let obj = `{
          "hallId": ${Number(o.hallId)},
          "movieEndTime": "${(new Date(movieEndTime)).toJSON()}",
          "movieStartTime": "${(new Date(movieStartTime)).toJSON()}",
          "planDate": "${(new Date(o.planDate)).toJSON()}",
          "ticketMoney": ${Number(plan_time_input.value)}
        },`
        arr += obj
      }
    }
  })
  arr = arr.substring(0, arr.length - 1)
  arr += ']'
  console.log(arr)

  $.ajax({
    url: `http://localhost:8080/addPlan/${movieId}/${userEntity.cinemaId}`,
    type: 'POST',
    data: arr,
    dataType: 'json',
    catch: false,      //清除上次请求的缓存
    contentType: 'application/json;charset=UTF-8',
    success: data => {
      console.log('新增演出计划', data)
      $.ajax({
        url: `http://localhost:8080/getPlan/${movieId}/${userEntity.cinemaId}`,
        type: 'get',
        dataType: 'json',
        catch: false,      //清除上次请求的缓存
        async: false,
        success: data => {
          console.log('该电影的演出计划', data)

          // 该页面全局获取信息
          plan = data
          // 清空盒子内所有内容
          $('#file_schedule').empty()
          // 获取所有分段日期
          let date_list = []
          Object.keys(data).forEach(function (key) {

            let date = (GetTime(key)).substring(5, 10)
            date = date.replace("-", "月");
            date_list.push(date)
          })

          // 将头部追加进去
          var str = `
          <div id="plan_detail_header">
            <a href="../html/administrator.html">
              <img src="../static/image/back.png" alt=""> 返回 </a>
            <button id="add_plan">新增</button>
          </div>
          <div id="plan_date_box">
          </div>`
          $('#file_schedule').append(`${str}`)

          // 将date_list有的日期加进去
          str = ``
          for (let i = 0; i < date_list.length; i++) {
            str += `<p class="plan_date">${date_list[i]}</p>`
          }
          $('#plan_date_box').append(`${str}`)

          $('.plan_date').css({ "background-color": "white", "color": "#4299e1" })

          let plan_date_arr = $('.plan_date')
          console.log(plan_date_arr)

          o.planDate = (GetTime(o.planDate)).substring(5, 10)
          o.planDate = (o.planDate).replace("-", "月")
          console.log(o.planDate)
          let current_date
          for (let j = 0; j < plan_date_arr.length; j++) {
            if (plan_date_arr[j].innerHTML == o.planDate) {
              console.log(plan_date_arr[j].innerHTML)
              current_date = plan_date_arr[j]
              console.log(current_date)
            }
          }
          current_date.style.backgroundColor = '#4299e1'
          current_date.style.color = 'white'

          // 添加列表项
          str = ` 
            <div class="all_hall" id="plan_list">
              <div class="hall">
                <p class="hall_name movie_title_name">电影名称</p>
                <p class="hall_sort movie_title_img">播放影厅</p>
                <p class="hall_line movie_title_video">上映时间</p>
                <p class="hall_column movie_title_intro">开始时间</p>
                <p class="hall_column movie_title_sort">票价</p>
                <p class="hall_operate staff_operator">操作</p>
              </div>
            </div>`
          $('#file_schedule').append(`${str}`)

          Object.keys(plan).forEach(function (key) {
            if ((GetTime(key)).substring(5, 10).replace("-", "月") == current_date.innerHTML) {
              str = ``
              for (let i = 0; i < plan[key].length; i++) {
                if (plan[key][i].hall != null) {
                  str += `
                    <form action="" class="hall">
                      <input name="id" value="${plan[key][i].id}" hidden/>
                      <p class="hall_name movie_title_name">${((plan[key][i]).movie).movieName}</p>
                      <p class="hall_sort movie_title_img">${(plan[key][i].hall).hallName}</p>
                      <p class="hall_line movie_title_video">${GetTime(plan[key][i].planDate).substring(0, 10)}</p>
                      <p class="hall_column movie_title_intro">${GetTime(plan[key][i].movieStartTime).substring(11, 19)}</p>
                      <p class="hall_column movie_title_sort">${plan[key][i].ticketMoney}</p>
                      <p class="hall_operate staff_operator">
                        <button type="reset" onclick="edit_order(this)" class="edit_order">编辑</button>
                        <button type="reset" class="delete_order">删除</button>
                      </p>
                    </form>`
                }

              }
              $('#plan_list').append(`${str}`)
            }
          })

        }
      })
      // 功能：弹出新增计划弹框
      $('#add_plan').on("click", function () {
        $('#float_plan').css({ "display": "block" })
        $('#new_plan_form').css({ "display": "block" })
        $('#edit_plan_form').css({ "display": "none" })

        $.ajax({
          url: `http://localhost:8080/getHalls/${userEntity.cinemaId}`,
          type: 'get',
          dataType: 'json',
          catch: false,
          success: data => {

            $('#new_plan_hall').empty()
            let str = ``
            Object.getOwnPropertyNames(data).forEach(function (key) {
              if (data[key].id != null) {
                str += `<option name="${data[key].id}">${data[key].hallName}</option>`
              }
            })

            $('#new_plan_hall').append(str)

          }
        })
      })

      // 功能：取消新增计划弹框
      $('#cancel_new_plan').on("click", function () {
        $('#float_plan').css({ "display": "none" })
        $('#new_plan_form').css({ "display": "none" })
        $('#edit_plan_form').css({ "display": "none" })
      })

      $('#float_plan').css({ "display": "none" })
      $('#new_plan_form').css({ "display": "none" })
      $('#edit_plan_form').css({ "display": "none" })
    }
  })
})


// 功能：点击删除按钮，删除演出计划
$('body').on("click", '.delete_order', function () {
  // 删除按钮所在的一行
  var parent = $(this).parent().parent()

  let line = parent.eq(0)
  var id_line = line.children().eq(0)
  // console.log(id_line[0].value)
  // console.log(parent)

  $.ajax({
    url: `http://localhost:8080/delPlan/${id_line[0].value}`,
    type: 'delete',
    dataType: 'json',
    catch: false,      //清除上次请求的缓存
    contentType: 'application/json;charset=UTF-8',
    success: data => {
      console.log('删除成功', data)
      parent.remove()
    }
  })

})


// 点击图标搜索对应内容
$('body').on("click", '#movie_search_icon', function () {
  function GetTime(date) {
    var datee = new Date(date).toJSON();
    return new Date(+new Date(datee) + 8 * 3600 * 1000).toISOString().
      replace(/T/g, ' ').replace(/\.[\d]{3}Z/, '')
  }

  var movie_name = $('#movie_search_name')[0].value
  // console.log(movie_name)

  var parent = $('.all_hall').eq(3)

  var total_movie_pages = ''
  $.ajax({
    url: `http://localhost:8080/searchMoviesByName/${movie_name}/0`,
    type: 'get',
    dataType: 'json',
    catch: false,      //清除上次请求的缓存
    contentType: 'application/json;charset=UTF-8',
    success: data => {
      console.log('模糊搜索演出计划板块电影', data)
      var str = ``
      for (var i = 0; i < data.length - 1; i++) {
        let actorList = ''
        for (let j = 0; j < data[i].movieActorList.length; j++) {
          actorList += data[i].movieActorList[j].actorName + ' 、'
        }
        actorList = actorList.substr(0, actorList.length - 2)
        // console.log(actorList)
        let decimal_score = ''
        if (String(data[i].movieScore).substring(2, 3) == '') {
          decimal_score = '0';
        } else {
          decimal_score = String(data[i].movieScore).substring(2, 3)
        }

        str += `
          <div class="movie_box plan_box" id="${data[i].id}">
            <img class="film_img"
              src="${data[i].movieHead}" alt="电影图片" />
            <div class="film_intro">
              <input value="${data[i].id}" type="text" hidden>
              <p><span class="film_intro_name">${data[i].movieName}</span><span class="film_intro_score"><big>${String(data[i].movieScore).substring(0, 1)}</big>.${decimal_score} </span></p>
              <p><span class="film_title">类型：</span><span class="film_sort_detail">${data[i].movieType}</span></p>
              <p><span class="film_title">导演：</span><span class="film_actor_detail">${actorList}</span></p>
              <p><span class="film_title">上映时间：</span><span class="film_time_detail">${GetTime(data[i].movieStart).substring(0, 10)}</span></p>
            </div>
        </div>`
      }
      parent.empty()
      parent.append(`${str}`)
      total_movie_pages = Number(data[data.length - 1].id + 1) * 5
      console.log(total_movie_pages)
    }
    , error: (e) => {
      console.log(e)

      $('.right_box').each(function () {
        $(this).css("display", "none");
      })

      var element = $('.right_box')[3];
      $(element).css("display", "block");
    }
  })


  layui.use('laypage', function () {
    var laypage = layui.laypage;

    //执行一个laypage实例
    laypage.render({
      elem: 'movie_plan_pages' //注意，这里的 test1 是 ID，不用加 # 号
      , count: total_movie_pages //数据总数，从服务端得到
      , limit: 5
      , theme: '#4299e1'
      // 当分页被切换时触发，函数返回两个参数：
      // obj（当前分页的所有选项值）、first（是否首次，一般用于初始加载的判断）
      , jump: function (obj, first) {
        //obj包含了当前分页的所有参数，比如：
        // console.log(obj.curr); //得到当前页，以便向服务端请求对应页的数据。
        $.ajax({
          url: `http://localhost:8080/searchMoviesByName/${movie_name}/${obj.curr - 1}`,
          type: 'get',
          dataType: 'json',
          catch: false,      //清除上次请求的缓存
          // contentType: 'application/json;charset=UTF-8',
          success: data => {
            var str = ``
            for (var i = 0; i < data.length - 1; i++) {
              let actorList = ''
              for (let j = 0; j < data[i].movieActorList.length; j++) {
                actorList += data[i].movieActorList[j].actorName + ' 、'
              }
              actorList = actorList.substr(0, actorList.length - 2)
              // console.log(actorList)
              let decimal_score = ''
              if (String(data[i].movieScore).substring(2, 3) == '') {
                decimal_score = '0';
              } else {
                decimal_score = String(data[i].movieScore).substring(2, 3)
              }

              str += `
                  <div class="movie_box plan_box" id="${data[i].id}">
                    <img class="film_img"
                      src="${data[i].movieHead}" alt="电影图片" />
                    <div class="film_intro">
                      <input value="${data[i].id}" type="text" hidden>
                      <p><span class="film_intro_name">${data[i].movieName}</span><span class="film_intro_score"><big>${String(data[i].movieScore).substring(0, 1)}</big>.${decimal_score} </span></p>
                      <p><span class="film_title">类型：</span><span class="film_sort_detail">${data[i].movieType}</span></p>
                      <p><span class="film_title">导演：</span><span class="film_actor_detail">${actorList}</span></p>
                      <p><span class="film_title">上映时间：</span><span class="film_time_detail">${GetTime(data[i].movieStart).substring(0, 10)}</span></p>
                    </div>
                </div>`
            }
            parent.empty()
            parent.append(`${str}`)
          },
          error: () => {
            $('.right_box').each(function () {
              $(this).css("display", "none");
            })

            var element = $('.right_box')[3];
            $(element).css("display", "block");
          }
        })
      }
    })
  })

})

