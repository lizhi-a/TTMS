
// 所属板块：管理员列表
// 功能：修改css
//      使用动画所用的js
//      除去提交form表单所用js


var userJsonStr = sessionStorage.getItem('cinema');
userEntity = JSON.parse(userJsonStr);



// 功能：点击新增管理员按钮，出现新增管理员的弹框
$('#new_staff').on("click", function () {
  $('#float_staff').css({ "display": "block" })
  $('#new_staff_form').css({ "display": "block" })
  $('#edit_staff_form').css({ "display": "none" })
})

// 功能：取消新增管理员弹框
$('#cancel_new_staff').on("click", function () {
  $('#float_staff').css({ "display": "none" })
  $('#new_staff_form').css({ "display": "none" })
  $('#edit_staff_form').css({ "display": "none" })
})

// 功能：提交新增管理员表单

$('#new_staff_form').on('submit', e => {
  e.preventDefault()
  let formData = $('#new_staff_form').serializeArray()

  var o = {}
  $.each(formData, function () {
    if (o[this.name]) {
      if (!o[this.name].push) {
        o[this.name] = [o[this.name]];
      }
      o[this.name].push(this.value || '');
    } else {
      o[this.name] = this.value || '';
    }
  })

  var parent = $('.all_hall').eq(0)
  console.log(o)
  let obj = {
    "accounts": `${o.accounts}`,
    "cinemaId": `${userEntity.cinemaId}`,
    "sellId": `${o.sellId}`,
    "password": `${o.password}`
  }
  obj = JSON.stringify(obj)
  console.log(obj)

  $.ajax({
    url: 'http://localhost:8080/addUser',
    type: 'POST',
    data: obj,
    dataType: 'json',
    catch: false,      //清除上次请求的缓存、
    contentType: 'application/json;charset=UTF-8',
    success: data => {
      console.log(data)
      if (data > -1) {
        console.log(o)
        console.log(o.sellId)
        switch (o.sellId) {
          case '0': o.sellId = '管理员'; break;
          case '1': o.sellId = '售票员'; break;
          default: o.sellId = 'null';
        }
        var str = `
           <form action="" class="hall">
            <input name="id" value="${data}" hidden></input>
            <p class="hall_name staff_num hall_p">${o.accounts}</p>
            <p class="hall_sort staff_psd hall_p">******</p>
            <p class="hall_sort staff_photo hall_p"><img src="../static/image/user.png" alt=""></p>
            <p class="hall_sort staff_job hall_p">${Number(o.sellId)}</p>
            <p class="hall_operate staff_operator">
              <button type="reset" onclick="edit_staff(this)" class="edit_staff">编辑</button>
              <button type="reset" class="delete_staff">删除</button>
            </p>
          </form>`
        parent.append(str)

        $('#float_staff').css({ "display": "none" })
        $('#new_staff_form').css({ "display": "none" })
        $('#edit_staff_form').css({ "display": "none" })

        $('.delete_staff').each(function () {
          $(this).on("click", function () {
            var parent = $(this).parent().parent()

            parent.remove()
          })
        })
        $('#cancel_new_staff').on("click", function () {
          $('#float_staff').css({ "display": "none" })
          $('#new_staff_form').css({ "display": "none" })
          $('#edit_staff_form').css({ "display": "none" })
        })

      }

    }
  })

})


// 功能：点击跳出编辑管理员表单
function edit_staff(t) {
  var parent = $(t).parent().parent()
  // 管理员id
  var id = parent.children()[0].value
  var accounts = parent.children()[1].innerHTML
  var password = parent.children()[2].innerHTML


  $('#float_staff').css({ "display": "block" })
  $('#new_staff_form').css({ "display": "none" })
  $('#edit_staff_form').css({ "display": "block" })

  $('#staff_id')[0].value = id
  $('#staff_edit_accounts')[0].value = accounts
  $('#staff_edit_psd')[0].value = password

}

// 功能：取消编辑管理员

$('#cancel_edit_staff').on("click", function () {
  $('#float_staff').css({ "display": "none" })
  $('#new_staff_form').css({ "display": "none" })
  $('#edit_staff_form').css({ "display": "none" })
})

// 功能：处理提交编辑管理员表单数据
// 完成
$('#edit_staff_form').on('submit', e => {
  e.preventDefault()
  const formData = $('#edit_staff_form').serializeArray()
  var o = {}

  $.each(formData, function () {
    if (o[this.name]) {
      if (!o[this.name].push) {
        o[this.name] = [o[this.name]];
      }
      o[this.name].push(this.value || '');
    } else {
      o[this.name] = this.value || '';
    }
  })
  var parent = $('.all_hall').eq(0)

  var obj = {
    "id": `${o.id}`,
    "accounts": `${o.accounts}`,
    "sellId": `${o.sellId}`,
    "cinemaId": `${userEntity.cinemaId}`,
    "password": `${o.password}`
  }
  obj = JSON.stringify(obj)
  console.log(obj)

  $.ajax({
    url: `http://localhost:8080/editSelf`,
    type: 'put',
    data: obj,
    dataType: 'json',
    catch: false,      //清除上次请求的缓存
    contentType: 'application/json;charset=UTF-8',
    success: data => {
      console.log(data)

      for (let i = 1; i < parent.children().length; i++) {

        let a = parent.children().eq(i)[0]
        if (a.childNodes[1].value == o.id) {

          switch (o.sellId) {
            case '0': o.sellId = '管理员'; break;
            case '1': o.sellId = '售票员'; break;
            default: o.sellId = 'null';
          }

          a.childNodes[3].innerHTML = o.accounts
          a.childNodes[5].innerHTML = '******'
          a.childNodes[9].innerHTML = o.sellId
        }
      }
      $('#float_staff').css({ "display": "none" })
      $('#new_staff_form').css({ "display": "none" })
      $('#edit_staff_form').css({ "display": "none" })

    }
  })

})



$('body').on("click", '.delete_staff', function () {
  // 删除按钮所在的一行
  var parent = $(this).parent().parent()

  let line = parent.eq(0)
  var id_line = line.children().eq(0)

  $.ajax({
    url: `http://localhost:8080/delUser/${id_line[0].value}/${userEntity.cinemaId}/1`,
    type: 'delete',
    dataType: 'json',
    catch: false,      //清除上次请求的缓存
    contentType: 'application/json;charset=UTF-8',
    success: data => {
      console.log(data)

      console.log('删除成功')
      parent.remove()
    }
  })
})