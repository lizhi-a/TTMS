
// 所属板块：管理订单
// 功能：修改css
//      使用动画所用的js
//      除去提交form表单所用js

// 选择开始时间，结束时间


var userJsonStr = sessionStorage.getItem('cinema');
userEntity = JSON.parse(userJsonStr);




// 功能：点击新增订单按钮，出现新增订单的弹框

$('#new_order').on("click", function () {
  $('#float_order').css({ "display": "block" })
  $('#new_order_form').css({ "display": "block" })
  $('#edit_order_form').css({ "display": "none" })
})


// 功能：取消新增订单弹框

$('#cancel_new_order').on("click", function () {
  $('#float_order').css({ "display": "none" })
  $('#new_hall_form').css({ "display": "none" })
  $('#edit_hall_form').css({ "display": "none" })
})


$('#order_search_icon').on('click', function () {

  function GetTime(date) {
    var datee = new Date(date).toJSON();
    return new Date(+new Date(datee) + 8 * 3600 * 1000).toISOString().
      replace(/T/g, ' ').replace(/\.[\d]{3}Z/, '')
  }

  var start = $('#start_time')[0].value
  var end = $('#end_time')[0].value

  var parent = $('.all_hall').eq(4)

  $.ajax({
    url: `http://localhost:8080/getOrdersByTime/${userEntity.cinemaId}/${start}/${end}/0`,
    type: 'get',
    dataType: 'json',
    catch: false,      //清除上次请求的缓存
    contentType: 'application/json;charset=UTF-8',
    success: data => {
      console.log('搜索时间段的电影', data)
      var str = `          
          <div class="hall">
            <p class="hall_name movie_title_name">电影名称</p>
            <p class="hall_sort movie_title_img">开始时间</p>
            <p class="hall_line movie_title_video">电影时长</p>
            <p class="hall_column movie_title_name">订单状态</p>
            <p class="hall_column movie_title_name">订单总价</p>
            <p class="hall_column movie_title_intro">影厅名称</p>
          </div>`
      for (var i = 0; i < data.length - 1; i++) {
        switch (data[i].orderStatus) {
          case '1': data[i].orderStatus = '已支付'; break;
          case '2': data[i].orderStatus = '未支付'; break;
          case '3': data[i].orderStatus = '退款'; break;
          default: data[i].orderStatus = 'null';
        }
        str += `
          <form action="" class="hall">
            <p class="hall_name movie_title_name">${data[i].movieName}</p>
            <p class="hall_sort movie_title_img">${GetTime(data[i].movieStartTime)}</p>
            <p class="hall_line movie_title_video">${data[i].movieTime}</p>
            <p class="hall_column movie_title_name">${data[i].orderStatus}</p>
            <p class="hall_column movie_title_name">${data[i].orderMoney}</p>
            <p class="hall_column movie_title_intro">${data[i].hallName}</p>
          </form>`
      }

      var parent = $('.all_hall').eq(4)
      parent.empty()
      parent.append(`${str}`)
      var search_order_pages = (Number(data[data.length - 1].cinemaName) + 1) * 5

      layui.use('laypage', function () {
        var laypage = layui.laypage;

        laypage.render({
          elem: 'order_pages' //注意，这里的 test1 是 ID，不用加 # 号
          , count: search_order_pages  //数据总数，从服务端得到
          , limit: 5
          , theme: '#4299e1'

          // 当分页被切换时触发，函数返回两个参数：
          // obj（当前分页的所有选项值）、first（是否首次，一般用于初始加载的判断）
          , jump: function (obj, first) {
            $.ajax({
              url: `http://localhost:8080/getOrdersByTime/${userEntity.cinemaId}/${start}/${end}/${obj.curr - 1}`,
              type: 'get',
              dataType: 'json',
              async: false,
              success: data => {
                console.log('搜索上下页', data)
                var str = `          
                  <div class="hall">
                    <p class="hall_name movie_title_name">电影名称</p>
                    <p class="hall_sort movie_title_img">开始时间</p>
                    <p class="hall_line movie_title_video">电影时长</p>
                    <p class="hall_column movie_title_name">订单状态</p>
                    <p class="hall_column movie_title_name">订单总价</p>
                    <p class="hall_column movie_title_intro">影厅名称</p>
                  </div>`
                for (var i = 0; i < data.length - 1; i++) {
                  switch (data[i].orderStatus) {
                    case '1': data[i].orderStatus = '已支付'; break;
                    case '2': data[i].orderStatus = '未支付'; break;
                    case '3': data[i].orderStatus = '退款'; break;
                    default: data[i].orderStatus = 'null';
                  }
                  str += `
                    <form action="" class="hall">
                      <p class="hall_name movie_title_name">${data[i].movieName}</p>
                      <p class="hall_sort movie_title_img">${GetTime(data[i].movieStartTime)}</p>
                      <p class="hall_line movie_title_video">${data[i].movieTime}</p>
                      <p class="hall_column movie_title_name">${data[i].orderStatus}</p>
                      <p class="hall_column movie_title_name">${data[i].orderMoney}</p>
                      <p class="hall_column movie_title_intro">${data[i].hallName}</p>
                    </form>`
                }

                var parent = $('.all_hall').eq(4)
                parent.empty()
                parent.append(`${str}`)
              }
            })
          }

        })
      })

    }
  })

})
